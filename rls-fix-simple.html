<!DOCTYPE html>
<html>
<head>
    <title>RLS Policy Fix</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>RLS Policy Fix</h1>
    <button onclick="applyFix()">Apply RLS Fix</button>
    <div id="result"></div>

    <script>
        const supabase = window.supabase.createClient(
            "https://supabase.rahedeen.com/",
            "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJzdXBhYmFzZSIsImlhdCI6MTc1NTc3OTgyMCwiZXhwIjo0OTExNDUzNDIwLCJyb2xlIjoiYW5vbiJ9.5CgjASpcB28n4UP1nrKmAP6_ODBJwpjgKy7_yhQZBxc"
        );

        async function applyFix() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p>Applying RLS policy fix...</p>';
            
            try {
                // Execute the SQL directly
                const { data, error } = await supabase.rpc('exec', {
                    sql: `
                        -- Drop existing policies
                        DROP POLICY IF EXISTS "Admins can manage all user roles" ON public.user_roles;
                        DROP POLICY IF EXISTS "Users can view their own role" ON public.user_roles;

                        -- Create new policies
                        CREATE POLICY "Users can insert their own role" 
                        ON public.user_roles 
                        FOR INSERT 
                        TO authenticated
                        WITH CHECK (user_id = auth.uid());

                        CREATE POLICY "Users can view their own role" 
                        ON public.user_roles 
                        FOR SELECT 
                        TO authenticated
                        USING (user_id = auth.uid());

                        CREATE POLICY "Admins can manage other user roles" 
                        ON public.user_roles 
                        FOR ALL
                        TO authenticated
                        USING (public.has_role(auth.uid(), 'admin'::public.user_role) AND user_id <> auth.uid())
                        WITH CHECK (public.has_role(auth.uid(), 'admin'::public.user_role) AND user_id <> auth.uid());

                        CREATE POLICY "Admins can update their own role" 
                        ON public.user_roles 
                        FOR UPDATE
                        TO authenticated
                        USING (public.has_role(auth.uid(), 'admin'::public.user_role) AND user_id = auth.uid())
                        WITH CHECK (public.has_role(auth.uid(), 'admin'::public.user_role) AND user_id = auth.uid());
                    `
                });
                
                if (error) {
                    resultDiv.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
                } else {
                    resultDiv.innerHTML = `<p style="color: green;">âœ… RLS policy fix applied successfully!</p>`;
                }
            } catch (err) {
                resultDiv.innerHTML = `<p style="color: red;">Error: ${err.message}</p>`;
            }
        }
    </script>
</body>
</html>


